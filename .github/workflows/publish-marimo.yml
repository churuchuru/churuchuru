on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'

            - name: Install uv
              uses: astral-sh/setup-uv@v2

            - name: Install dependencies
              run: cd python && uv sync

            - name: Create output directory
              run: mkdir -p build

            - name:  Export notebooks
              run: |
                  mkdir -p build/python
                  cd python
                  find exercises -name "*.py" -type f | while read file; do
                    filename=$(basename "$file" .py)
                    notebook_dir="../build/python/${filename}"
                    mkdir -p "$notebook_dir"
                    uv run marimo export html-wasm "$file" -o "$notebook_dir/index.html" --mode edit
                  done

            - name: ğŸ  Generate metadata and copy homepage files
              run: |
                  # Run the metadata generation script to create metadata.json
                  bash homepage/generate-metadata.sh
                  # Minify CSS
                  cd homepage
                  npx cssnano-cli style.css -o style.min.css 2>/dev/null || sed 's/\/\*[^*]*\*\+\([^/*][^*]*\*\+\)*\///g' style.css | tr -s ' ' | sed 's/ *{ */{/g; s/ *} *}/}/g; s/ *: */:/' > style.min.css
                  # Minify JS
                  npx terser script.js -o script.min.js -c -m 2>/dev/null || sed 's/\/\/.*$//' script.js | sed 's/\/\*[\s\S]*?\*\///g' | tr '\n' ' ' | tr -s ' ' | sed 's/ //g' > script.min.js
                  cd ..
                  # Copy homepage files to build directory
                  cp homepage/index.html build/index.html
                  cp homepage/metadata.json build/metadata.json
                  cp homepage/script.js build/script.js
                  cp homepage/script.min.js build/script.min.js
                  cp homepage/style.css build/style.css
                  cp homepage/style.min.css build/style.min.css

            - name: ğŸ“¦ Upload Pages Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: build

    deploy:
        needs: build
        runs-on: ubuntu-latest
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        permissions:
            pages: write
            id-token: write

        steps:
            - name: ğŸŒ Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
              with:
                  artifact_name: github-pages